name: Deploy

on:
  push:
    branches: [master]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - uses: actions/checkout@v4

      # 2. Set up Docker Buildx (for better caching later)
      - uses: docker/setup-buildx-action@v3

      # 3. Login to DigitalOcean Container Registry
      - name: Login to DigitalOcean Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.digitalocean.com
          username: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          password: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      # 4. Build PHP image (tagged locally)
      - name: Build PHP image
        run: docker build -t workouts-php:latest -f .docker/php/Dockerfile.prod .

      # 5. Build Nginx image (depends on PHP)
      - name: Build Nginx image
        run: docker build -t workouts-nginx:latest -f .docker/nginx/Dockerfile.prod .

      # 6. Smoke test (verify app boots - full tests run in tests.yml)
      - name: Smoke test
        run: |
          docker run --rm workouts-php:latest php artisan --version
          docker run --rm workouts-php:latest php artisan about

      # 7. Tag and push images to DigitalOcean Container Registry
      - name: Push images to registry
        env:
          REGISTRY: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}
        run: |
          # Tag with SHA and latest
          docker tag workouts-php:latest $REGISTRY/workouts-php:${{ github.sha }}
          docker tag workouts-php:latest $REGISTRY/workouts-php:latest
          docker tag workouts-nginx:latest $REGISTRY/workouts-nginx:${{ github.sha }}
          docker tag workouts-nginx:latest $REGISTRY/workouts-nginx:latest

          # Push all tags
          docker push $REGISTRY/workouts-php:${{ github.sha }}
          docker push $REGISTRY/workouts-php:latest
          docker push $REGISTRY/workouts-nginx:${{ github.sha }}
          docker push $REGISTRY/workouts-nginx:latest

      # 8. Copy docker-compose.prod.yml to server
      - name: Copy docker-compose file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PRODUCTION_SSH_HOST }}
          username: ${{ secrets.PRODUCTION_SSH_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          source: "docker-compose.prod.yml"
          target: ${{ secrets.PRODUCTION_APP_PATH }}

      # 9. Deploy to server via SSH
      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        env:
          REGISTRY: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY_NAME }}
          DO_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          APP_PATH: ${{ secrets.PRODUCTION_APP_PATH }}
          ENV_PRODUCTION: ${{ secrets.ENV_PRODUCTION }}
          ENV_DOCKER_PROD: ${{ secrets.ENV_DOCKER_PROD }}
        with:
          host: ${{ secrets.PRODUCTION_SSH_HOST }}
          username: ${{ secrets.PRODUCTION_SSH_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          envs: REGISTRY,DO_TOKEN,APP_PATH,ENV_PRODUCTION,ENV_DOCKER_PROD
          script_stop: true
          script: |
            cd $APP_PATH

            # Login to DO registry on server
            echo "$DO_TOKEN" | docker login registry.digitalocean.com -u "$DO_TOKEN" --password-stdin

            # Write env files from GitHub secrets
            echo "$ENV_DOCKER_PROD" > .env.docker.prod
            echo "$ENV_PRODUCTION" > .env.production

            # Pull new images
            docker pull $REGISTRY/workouts-php:latest
            docker pull $REGISTRY/workouts-nginx:latest

            # Terminate Horizon before restarting (|| true for first deploy when container doesn't exist)
            docker-compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T horizon php artisan horizon:terminate --wait || true

            # Pull and restart containers
            docker-compose -f docker-compose.prod.yml --env-file .env.docker.prod up -d

            # Set up storage symlink (idempotent)
            docker-compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan storage:link || true

            # Run migrations
            docker-compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan migrate --force

            # Clear and rebuild caches
            docker-compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan config:cache
            docker-compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan route:cache
            docker-compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan view:cache

            # Seed global exercises (idempotent - uses firstOrCreate)
            docker-compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan db:seed --class=GlobalExerciseSeeder --force

            # Health check
            docker-compose -f docker-compose.prod.yml --env-file .env.docker.prod ps
