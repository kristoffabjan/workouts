name: Deploy

on:
  push:
    branches: [master]

jobs:
  tests:
    uses: ./.github/workflows/tests.yml
    secrets: inherit

  build-deploy:
    needs: tests
    runs-on: ubuntu-latest
    environment: Prod
    steps:
      # 1. Checkout code
      - uses: actions/checkout@v4

      # 2. Set up Docker Buildx
      - uses: docker/setup-buildx-action@v3

      # 3. Install doctl and login to DigitalOcean Container Registry
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      # 4. Build PHP image (with layer caching)
      - name: Build PHP image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .docker/php/Dockerfile.prod
          load: true
          tags: workouts-php:latest
          cache-from: type=gha,scope=php
          cache-to: type=gha,mode=max,scope=php

      # 5. Build Nginx image (reuses PHP image for static assets)
      - name: Build Nginx image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .docker/nginx/Dockerfile.prod
          load: true
          tags: workouts-nginx:latest
          build-contexts: |
            workouts-php:latest=docker-image://workouts-php:latest
          cache-from: type=gha,scope=nginx
          cache-to: type=gha,mode=max,scope=nginx

      # 6. Smoke test
      - name: Smoke test
        run: |
          docker run --rm workouts-php:latest php artisan --version
          docker run --rm workouts-php:latest php artisan about

      # 7. Tag and push images to DigitalOcean Container Registry
      - name: Push images to registry
        env:
          REGISTRY: registry.digitalocean.com/${{ vars.DIGITALOCEAN_REGISTRY_NAME }}
        run: |
          docker tag workouts-php:latest $REGISTRY/workouts-php:${{ github.sha }}
          docker tag workouts-php:latest $REGISTRY/workouts-php:latest
          docker tag workouts-nginx:latest $REGISTRY/workouts-nginx:${{ github.sha }}
          docker tag workouts-nginx:latest $REGISTRY/workouts-nginx:latest

          docker push $REGISTRY/workouts-php:${{ github.sha }}
          docker push $REGISTRY/workouts-php:latest
          docker push $REGISTRY/workouts-nginx:${{ github.sha }}
          docker push $REGISTRY/workouts-nginx:latest

      # 8. Copy docker-compose.prod.yml to server
      - name: Copy docker-compose file to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ vars.PRODUCTION_SSH_HOST }}
          username: ${{ vars.PRODUCTION_SSH_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          source: "docker-compose.prod.yml"
          target: ${{ vars.PRODUCTION_APP_PATH }}

      # 9. Deploy to server via SSH
      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        env:
          REGISTRY: registry.digitalocean.com/${{ vars.DIGITALOCEAN_REGISTRY_NAME }}
          DO_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          APP_PATH: ${{ vars.PRODUCTION_APP_PATH }}
          ENV_PRODUCTION: ${{ secrets.ENV_PRODUCTION }}
          ENV_DOCKER_PROD: ${{ secrets.ENV_DOCKER_PROD }}
        with:
          host: ${{ vars.PRODUCTION_SSH_HOST }}
          username: ${{ vars.PRODUCTION_SSH_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          envs: REGISTRY,DO_TOKEN,APP_PATH,ENV_PRODUCTION,ENV_DOCKER_PROD
          script_stop: true
          script: |
            cd $APP_PATH

            # Login to DO registry on server
            echo "$DO_TOKEN" | docker login registry.digitalocean.com -u "$DO_TOKEN" --password-stdin

            # Write env files from GitHub secrets
            echo "$ENV_DOCKER_PROD" > .env.docker.prod
            echo "$ENV_PRODUCTION" > .env.production

            # Pull new images
            docker pull $REGISTRY/workouts-php:latest
            docker pull $REGISTRY/workouts-nginx:latest

            # Terminate Horizon before restarting (|| true for first deploy when container doesn't exist)
            docker compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T horizon php artisan horizon:terminate --wait || true

            # Pull and restart containers
            docker compose -f docker-compose.prod.yml --env-file .env.docker.prod up -d

            # Set up storage symlink (idempotent)
            docker compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan storage:link || true

            # Run migrations
            docker compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan migrate --force

            # Clear and rebuild caches
            docker compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan config:cache
            docker compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan route:cache
            docker compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan view:cache

            # Seed global exercises (idempotent - uses firstOrCreate)
            docker compose -f docker-compose.prod.yml --env-file .env.docker.prod exec -T php php artisan db:seed --class=GlobalExerciseSeeder --force

            # Health check
            docker compose -f docker-compose.prod.yml --env-file .env.docker.prod ps
